# ============================================
# Supervisor Configuration - PrevLab Railway
# Gerencia Nginx + Uvicorn no mesmo container
# ============================================

[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
loglevel=info
user=root

# ========== Nginx (Frontend) ==========
[program:nginx]
command=/usr/sbin/nginx -g "daemon off;"
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
autorestart=true
startretries=3
priority=10

# ========== Uvicorn (Backend) ==========
[program:uvicorn]
command=uvicorn src.api.main:app --host 0.0.0.0 --port 8000 --workers %(ENV_WORKERS)s --log-level %(ENV_LOG_LEVEL)s
directory=/app
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
autorestart=true
startretries=3
priority=20
environment=PYTHONUNBUFFERED=1,DATABASE_URL="%(ENV_DATABASE_URL)s"

# ========== Event Listener ==========
# Encerra supervisor se algum processo cr√≠tico falhar
[eventlistener:processes]
command=sh -c "printf 'READY\n' && while read line; do kill -15 $PPID; done < /dev/stdin"
events=PROCESS_STATE_FATAL,PROCESS_STATE_STOPPED
